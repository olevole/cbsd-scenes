#!/bin/sh
#v10.0.2
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="rootpw gitlabpw fqdn gitlablang"
MYDESC="gitlab image helper"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${system}
. ${color}
init $*

BACKTITLE="--backtitle \Z1${0}\Zn --colors"
DIALOG=${DIALOG=/usr/bin/dialog}
SKELDIR="${jailsysdir}/${jname}/skel"

install_gitlab()
{

	cp -Rp ${SKELDIR}/bin ${path}/root/bin
        cp -Rp ${SKELDIR}/etc ${path}/root/etc
        cp -Rp ${SKELDIR}/skel ${path}/root/skel
        cat > ${path}/tmp/rminstall.sh <<EOF
#!/bin/sh
#
#
cp /root/skel/cront-tabs-root /var/cron/tabs/root && chmod 0600 /var/cron/tabs/root
/root/skel/rmdb
/root/skel/rmprepare ${fqdn}
rm -rf /root/skel
echo
echo -e "\033[1m* gitlab configured *\033[0m"
echo
rm -f /tmp/rminstall.sh
EOF

	mount -t devfs devfs ${path}/dev
	sysrc -f ${path}/etc/rc.conf mysql_enable=YES
	sysrc -f ${path}/etc/rc.conf nginx_enable=YES
	sysrc -f ${path}/etc/rc.conf redis_enable=YES
	sysrc -f ${path}/etc/rc.conf gitlab_enable=YES
	chroot ${path} /bin/sh /tmp/rminstall.sh
	umount ${path}/dev
	cbsd jcleanup jname=${jname}

    exit

}


myconf()
{
    tempfile=`mktemp ${ftmpdir}/xconf.XXXX`
    trap "rm -f ${tempfile}" 0 1 2 3

    returncode=0
    while test $returncode != 1 && test $returncode != 250; do
	exec 3>&1
	value=`$DIALOG ${BACKTITLE} --ok-label "Install" --title "gitlab jail install" --form "gitlab configuration" \
0 0 1 \
        "Real fqdn (eg: gitlab.my.domain):"       1 1      ""  1  35 40 40 \
2>&1 1>&3`

	returncode=$?
	exec 3>&-

	case ${returncode} in
	    0)
		I=0
		for  a in ${value}; do
		    case $I in
			0)
			    fqdn="${a}"
			    ;;
		    esac
		    I=$(( I + 1 ))
		done

		if [ -z "${fqdn}" ]; then
		    echo "Please fill all inputs"
		    read p
		    returncode=5
		else
		    install_gitlab
		fi
		;;
            *)
                cbsd jcleanup jname=${jname}
                exit
        esac

    done
}

### MAIN
. ${etcdir}/buildworld.conf
. ${workdir}/universe.subr

. ${jrcconf}
[ $? -eq 1 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"

init_target_arch
init_basedir

[ $baserw -eq 1 ] && path=$data
[ ! -d "${path}" ] && mkdir -p ${path}

amount=0

if  is_mounted "${path}"; then
    amount=1
fi

if [ $amount -eq 0 ]; then
    mountbase
    mountfstab
fi

# auto install by arg
[ -n "${fqdn}" ] && install_gitlab
# wizard
myconf

cbsd jcleanup jname=${jname}
