#!/bin/sh
#v10.0.6
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="rootpw redminepw fqdn redminelang"
MYDESC="redmine image helper"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${inventory}
. ${system}
. ${color}
init $*

BACKTITLE="--backtitle \Z1${0}\Zn --colors"
DIALOG=${DIALOG=/usr/bin/dialog}
SKELDIR="${jailsysdir}/${jname}/skel"
PRODUCT="redmine"

install_img()
{
	mount -t devfs devfs ${path}/dev

chroot ${path} /bin/sh << EOF
/root/skel/rmdb ${rootpw} ${redminepw}
/root/skel/rmprepare ${fqdn} ${redminelang}
rm -rf /root/skel
echo
echo -e "\033[1m* Redmine configured *\033[0m"
echo -e "\033[0;35mMySQL password stored in your \033[0;32m/root/etc\033[0;35m directory.\033[0m"
echo -e "\033[0;35mYou can access to Redmine via http://${fqdn}/ with default Redmine credential:\033[0m"
echo -e "\033[0;35mLogin: \033[0;32madmin\033[0m"
echo -e "\033[0;35mPassword: \033[0;32madmin\033[0m"
echo
EOF

	${ECHO} "${MAGENTA}${PRODUCT} installed${NORMAL}"
	umount ${path}/dev
	rm -rf ${path}/usr/local/etc/pkg/repos
	cbsd jcleanup jname=${jname}
	umount ${path}
	echo
	exit 0
}

myconf()
{
	tempfile=$( mktemp ${ftmpdir}/xconf.XXXX )
	trap "rm -f ${tempfile}" 0 1 2 3

	returncode=0
	while test $returncode != 1 && test $returncode != 250; do
	    exec 3>&1
	    value=$( $DIALOG ${BACKTITLE} --ok-label "Install" --title "Redmine jail install" --form "Redmine configuration" 0 0 5 \
	    "MySQL root password:"  1 1      "" 1  35 20 20 \
	    "MySQL redmine password:"       2 1      ""  2  35 20 20 \
	    "Real fqdn (eg: redmine.my.domain):"       3 1      ""  3  35 40 40 \
	    "Redmine Lang (en,ru,fr,de,...):"       4 1      "en"  4  35 3 40 \
	    2>&1 1>&3 )

	    returncode=$?
	    exec 3>&-

	    case ${returncode} in
		0)
			I=0
			for  a in ${value}; do
			    case $I in
				0)
				    rootpw=${a}
				;;
				1)
				    redminepw="${a}"
				;;
				2)
				    fqdn="${a}"
				;;
				3)
				    redminelang="${a}"
				;;
			    esac
			    I=$(( I + 1 ))
			done

		    if [ -z "${rootpw}" -o -z "${redminepw}" -o -z "${fqdn}" -o -z "${redminelang}" ]; then
			    echo "Please fill all inputs"
			    read p
			    returncode=5
		    else
			install_img
		    fi
		    ;;
		*)
		    cbsd jcleanup jname=${jname}
		    umount ${path}
		    exit 0
	    esac
	done
}


### MAIN
. ${etcdir}/buildworld.conf
. ${workdir}/universe.subr
. ${jrcconf}
[ $? -eq 1 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"
[ ${jid} -ne 0 ] && err 1 "${MAGENTA}Error: jail is active${NORMAL}"

init_target_arch
init_basedir

[ $baserw -eq 1 ] && path=$data
[ ! -d "${path}" ] && mkdir -p ${path}

if ! is_mounted "${path}"; then
    mountbase
fi

mountfstab

# auto install by arg
[ -n "${rootpw}" -a -n "${redminepw}" -a -n "${fqdn}" -a -n "${redminelang}" ] && install_img
# wizard
myconf

cbsd jcleanup jname=${jname}
umount ${path}
